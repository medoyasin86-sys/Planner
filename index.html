<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Ø¯ÙØªØ± Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø±Ù…Ø¶Ø§Ù† 1447Ù‡Ù€ / 2026</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Reem+Kufi:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#1a4d2e; --gold:#c5a059; --gold-light:#e6cc92; --bg:#f9f6f0;
      --card-bg:#ffffff; --text:#1a4d2e; --accent:#d35400; --crimson:#900c3f;
    }
    body.dark{ --bg:#121212; --card-bg:#1e1e1e; --text:#e0e0e0; --primary:#2d6a4f; }
    body{ font-family:'Amiri',serif; background:var(--bg); color:var(--text); margin:0; padding:12px; transition:.25s background; }
    .container{ max-width:980px; margin:auto; background:var(--card-bg); border:3px double var(--gold); border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.2); padding:14px; position:relative; }
    .dark-toggle{ position:fixed; top:14px; left:14px; width:40px; height:40px; border-radius:50%; border:none; background:var(--gold); cursor:pointer; font-size:1.2rem; box-shadow:0 2px 10px rgba(0,0,0,.2); z-index:1000; }
    .header{ background:linear-gradient(135deg,#1a4d2e,#0a2b1a); color:#fff; padding:16px; border-radius:16px; border:2px solid var(--gold); text-align:center; }
    .header h2{ margin:0; font-family:'Reem Kufi'; color:var(--gold-light); letter-spacing:.5px; }
    .dates{ margin-top:10px; display:grid; grid-template-columns: 1fr; gap:10px; }
    .date-box{ background:rgba(255,255,255,.1); border:1px solid rgba(197,160,89,.3); padding:10px; border-radius:12px; }
    .date-row{ display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .date-row input[type="date"]{ border:none; border-radius:6px; padding:6px 8px; font-weight:bold; text-align:center; }
    #hijri{ display:block; color:var(--gold-light); font-weight:bold; margin-top:6px; }

    .table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:.9rem; background:rgba(0,0,0,.08); border-radius:10px; overflow:hidden; }
    .table th,.table td{ padding:8px; border:1px solid rgba(255,255,255,.15); text-align:center; color:#fff; }
    .table thead{ background:rgba(0,0,0,.25); }
    .city-row{ background:rgba(0,0,0,.15); }

    .banner{ background:rgba(255,255,255,.1); border:1px solid var(--gold-light); color:#fff; border-radius:10px; padding:10px; margin-top:10px; line-height:1.7; }
    .timer{ color:var(--gold-light); background:var(--primary); padding:4px 10px; border-radius:20px; font-family:sans-serif; direction:ltr; }
    .alert{ display:none; background:linear-gradient(135deg,#fff9e6,#fffde7); border:2px solid var(--gold); color:#856404; padding:10px; border-radius:12px; text-align:center; margin-top:10px; font-weight:bold; box-shadow:0 0 15px rgba(197,160,89,.4); animation:lightPulse 2s infinite; }
    @keyframes lightPulse{ 0%{box-shadow:0 0 5px rgba(197,160,89,.4)} 50%{box-shadow:0 0 20px rgba(197,160,89,.8)} 100%{box-shadow:0 0 5px rgba(197,160,89,.4)} }

    .marquee{ background:var(--accent); color:#fff; border:2px solid var(--gold); border-radius:14px; padding:12px 15px; margin:15px 0; text-align:center; font-size:1.05rem; box-shadow:0 4px 10px rgba(0,0,0,.1); }
    .section{ background:#fff; border:1px solid var(--gold); border-radius:14px; margin-top:12px; overflow:hidden; }
    body.dark .section{ background:#1e1e1e; }
    .section .title{ background:var(--primary); color:#fff; margin:0; padding:10px; font-size:1rem; }
    .row{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px dashed var(--gold-light); gap:8px; }
    .pts{ font-size:.75rem; color:#666; display:block; }
    .opts{ display:flex; gap:4px; flex-wrap:wrap; }
    .btn{ font-size:.8rem; padding:6px 8px; border-radius:6px; border:1px solid var(--gold); background:transparent; color:inherit; cursor:pointer; }
    .btn.sel{ background:var(--gold); color:#fff; }
    .check{ transform:scale(1.3); cursor:pointer; }
    .link{ color:var(--primary); text-decoration:none; border-bottom:1px solid var(--gold); }

    .grid-2{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:10px; }
    .progress-wrap{ padding:10px; }
    .progress-bar{ width:100%; height:12px; background:#eee; border-radius:10px; overflow:hidden; }
    .progress-bar > span{ display:block; height:100%; background:linear-gradient(90deg,#c5a059,#1a4d2e); width:0%; transition:.4s width; }

    .stats{ display:flex; justify-content:space-between; align-items:center; padding:6px 10px; color:#333; background:#faf6ea; border:1px dashed var(--gold); border-radius:10px; margin-top:10px; }
    body.dark .stats{ background:#2a2a2a; color:#fff; }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:8px; }
    .pill{ background:#f1f1f1; border:1px solid #ddd; color:#333; border-radius:20px; padding:6px 10px; cursor:pointer; }
    body.dark .pill{ background:#2a2a2a; color:#fff; border-color:#444; }

    /* helpers */
    .muted{ opacity:.85; font-size:.9rem; }
    .note{ color:#856404; }
  </style>
</head>
<body>
  <button class="dark-toggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ" onclick="toggleDark()">ğŸŒ“</button>

  <div class="container">
    <div class="header">
      <h2>ğŸ•Œ Ø¯ÙØªØ± Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø±Ù…Ø¶Ø§Ù† 1447Ù‡Ù€ / 2026</h2>
      <div class="dates">
        <div class="date-box">
          <div class="date-row">
            <span>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ:</span>
            <input type="date" id="datePicker">
          </div>
          <span id="hijri">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠâ€¦</span>
        </div>

        <div class="date-box">
          <div class="date-row">
            <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
            <input id="city" placeholder="Ù…Ø«Ø§Ù„: Salalah" style="padding:6px;border-radius:6px;border:none;">
            <label>Ø§Ù„Ø¯ÙˆÙ„Ø©:</label>
            <input id="country" placeholder="Ù…Ø«Ø§Ù„: Oman" style="padding:6px;border-radius:6px;border:none;">
            <button class="pill" onclick="saveLocation()">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
          </div>

          <table class="table">
            <thead><tr><th>Ø§Ù„ÙØ¬Ø±</th><th>Ø§Ù„Ø¸Ù‡Ø±</th><th>Ø§Ù„Ø¹ØµØ±</th><th>Ø§Ù„Ù…ØºØ±Ø¨</th><th>Ø§Ù„Ø¹Ø´Ø§Ø¡</th></tr></thead>
            <tbody id="times"><tr class="city-row"><td colspan="5">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø¯ÙˆÙ„Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</td></tr></tbody>
          </table>

          <div id="nextBanner" class="banner">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øªâ€¦</div>
          <div id="wuduAlert" class="alert">ğŸŒŠ Ø­Ø§Ù† Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„ÙˆØ¶ÙˆØ¡â€¦</div>
        </div>
      </div>
    </div>

    <div class="marquee" id="hadith">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…â€¦</div>

    <!-- ØµÙŠØ§Ù… Ø±Ù…Ø¶Ø§Ù† -->
    <div class="section">
      <h3 class="title" style="background:var(--accent)">ğŸŒ™ Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù… (Ø±Ù…Ø¶Ø§Ù†)</h3>
      <div class="row">
        <span>ØµÙ…ØªÙ Ø§Ù„ÙŠÙˆÙ… <small class="pts">(+100 Ù†Ù‚Ø·Ø©)</small></span>
        <input id="fasting" type="checkbox" class="check" onchange="save('fasting',{done:this.checked,p:this.checked?100:0})">
      </div>
      <div class="row">
        <div>
          <b>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù„Ù„Ø³Ù‘ÙØ­ÙˆØ±/Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ (Ø§Ù„ÙØ¬Ø±):</b>
          <div><span id="suhoorTimer" class="timer">--</span></div>
        </div>
        <div>
          <b>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù„Ù„Ø¥ÙØ·Ø§Ø± (Ø§Ù„Ù…ØºØ±Ø¨):</b>
          <div><span id="iftarTimer" class="timer">--</span></div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„ÙØ±Ø§Ø¦Ø¶ -->
    <div class="section">
      <h3 class="title">ğŸ•‹ Ø§Ù„ÙØ±Ø§Ø¦Ø¶ (Ù…Ø³Ø¬Ø¯ | Ø¬Ù…Ø§Ø¹Ø© | ÙØ±Ø¯ÙŠ | Ù‚Ø¶Ø§Ø¡)</h3>
      <div id="fardList"></div>
    </div>

    <!-- Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­ ÙˆØ§Ù„ÙˆØªØ± -->
    <div class="section">
      <h3 class="title">ğŸŒŒ Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­ ÙˆØ§Ù„ÙˆØªØ±</h3>
      <div class="row">
        <span>ğŸ•¯ï¸ ØµÙ„Ø§Ø© Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­ <small class="pts">(+40 Ù†Ù‚Ø·Ø©)</small></span>
        <input id="taraweeh" type="checkbox" class="check" onchange="save('taraweeh',{done:this.checked,p:this.checked?40:0})">
      </div>
      <div class="row">
        <span>ğŸŒŸ Ø§Ù„ÙˆØªØ± <small class="pts">(+20 Ù†Ù‚Ø·Ø©)</small></span>
        <input id="s_witr" type="checkbox" class="check" onchange="save('s_witr',{done:this.checked,p:this.checked?20:0})">
      </div>
    </div>

    <!-- Ø§Ù„Ø³Ù†Ù† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ -->
    <div class="section">
      <h3 class="title">ğŸŒ± Ø§Ù„Ø³Ù†Ù† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</h3>
      <div id="sunanList"></div>
    </div>

    <!-- Ø§Ù„Ø£Ø°ÙƒØ§Ø± ÙˆØ§Ù„ÙˆØ±Ø¯ + Ø®ØªÙ…Ø© -->
    <div class="section">
      <h3 class="title">ğŸ“¿ Ø§Ù„Ø£Ø°ÙƒØ§Ø± ÙˆØ§Ù„ÙˆØ±Ø¯</h3>
      <div id="extraList"></div>

      <div class="grid-2">
        <div class="progress-wrap">
          <div class="row" style="border-bottom:none">
            <div>
              <b>ğŸ“– Ø®ØªÙ…Ø© Ø±Ù…Ø¶Ø§Ù†</b>
              <div class="muted">Ø§Ø®ØªØ± Ø¢Ø®Ø± Ø¬Ø²Ø¡ Ø£Ù†Ù‡ÙŠØªÙ‡ Ø§Ù„ÙŠÙˆÙ… (1â€“30)</div>
            </div>
            <select id="juzSelect" style="padding:6px;border-radius:6px;border:1px solid var(--gold);" onchange="save('khatmah',{juz:+this.value||0})">
              <option value="0">â€” Ù„Ù… Ø£Ø­Ø¯Ø¯ â€”</option>
              ${Array.from({length:30}).map((_,i)=>`<option value="${i+1}">Ø§Ù„Ø¬Ø²Ø¡ ${i+1}</option>`).join('')}
            </select>
          </div>
          <div class="progress-bar"><span id="juzBar"></span></div>
          <div class="muted" id="juzText">ØªÙ‚Ø¯Ù‘Ù… Ø§Ù„Ø®ØªÙ…Ø©: 0%</div>
        </div>

        <div class="progress-wrap">
          <div class="row" style="border-bottom:none">
            <div>
              <b>âœ¨ Ù…Ù„Ø­ÙˆØ¸Ø©</b>
              <div class="muted">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„ÙƒÙ„ ÙŠÙˆÙ…ØŒ ÙˆÙŠÙ…ÙƒÙ† ØªØµØ¯ÙŠØ±Ù‡Ø§.</div>
            </div>
            <div class="actions">
              <button class="pill" onclick="exportDay()">ØªØµØ¯ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</button>
              <label class="pill" style="cursor:pointer">
                Ø§Ø³ØªÙŠØ±Ø§Ø¯
                <input type="file" accept="application/json" style="display:none" onchange="importDay(this)">
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª -->
    <div class="stats">
      <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…: <b id="totalPts">0</b> Ù†Ù‚Ø·Ø©</div>
      <div class="note">ğŸ’¡ ØªØ°ÙƒÙŠØ±: ÙØ¶Ù‘Ù„ Ø§Ù„Ù…Ø³Ø¬Ø¯/Ø§Ù„Ø¬Ù…Ø§Ø¹Ø© ÙÙŠ Ø§Ù„ÙØ±Ø§Ø¦Ø¶ØŒ ÙˆØ£Ø­Ø³Ù† Ø®ØªÙ…ØªÙƒ.</div>
    </div>
  </div>

  <!-- APIs -->
  <script>
    // Hadiths
    const AHADITH = [
      "Ù‚Ø§Ù„ ï·º: (Ù…Ù† ØµØ§Ù… Ø±Ù…Ø¶Ø§Ù† Ø¥ÙŠÙ…Ø§Ù†Ù‹Ø§ ÙˆØ§Ø­ØªØ³Ø§Ø¨Ù‹Ø§ ØºÙÙÙØ± Ù„Ù‡ Ù…Ø§ ØªÙ‚Ø¯Ù… Ù…Ù† Ø°Ù†Ø¨Ù‡).",
      "Ù‚Ø§Ù„ ï·º: (ØªØ³Ø­Ù‘Ø±ÙˆØ§ ÙØ¥Ù† ÙÙŠ Ø§Ù„Ø³Ù‘ÙØ­ÙˆØ± Ø¨Ø±ÙƒØ©).",
      "Ù‚Ø§Ù„ ï·º: (Ù…Ù† Ù‚Ø§Ù… Ø±Ù…Ø¶Ø§Ù† Ø¥ÙŠÙ…Ø§Ù†Ù‹Ø§ ÙˆØ§Ø­ØªØ³Ø§Ø¨Ù‹Ø§ ØºÙÙÙØ± Ù„Ù‡ Ù…Ø§ ØªÙ‚Ø¯Ù… Ù…Ù† Ø°Ù†Ø¨Ù‡).",
      "Ù‚Ø§Ù„ ï·º: (Ø§Ù„Ø¯Ø¹Ø§Ø¡ Ù‡Ùˆ Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø©).",
      "Ù‚Ø§Ù„ ï·º: (Ø£Ø­Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ø£Ø¯ÙˆÙ…Ù‡Ø§ ÙˆØ¥Ù† Ù‚Ù„).",
      "Ù‚Ø§Ù„ ï·º: (Ù…Ù† Ù‚Ø§Ù… Ù…Ø¹ Ø§Ù„Ø¥Ù…Ø§Ù… Ø­ØªÙ‰ ÙŠÙ†ØµØ±Ù ÙƒÙØªØ¨ Ù„Ù‡ Ù‚ÙŠØ§Ù… Ù„ÙŠÙ„Ø©)."
    ];

    const model = {
      fard: [
        {id:'fajr', n:'ğŸŒ„ Ø§Ù„ÙØ¬Ø±', pts:{m:100,g:30,f:15,q:5}, d:'Ù…:100|Ø¬:30|Ù:15|Ù‚:5'},
        {id:'dhuhr', n:'â˜€ï¸ Ø§Ù„Ø¸Ù‡Ø±', pts:{m:50,g:30,f:15,q:5}, d:'Ù…:50|Ø¬:30|Ù:15|Ù‚:5'},
        {id:'asr', n:'ğŸŒ¤ï¸ Ø§Ù„Ø¹ØµØ±', pts:{m:50,g:30,f:15,q:5}, d:'Ù…:50|Ø¬:30|Ù:15|Ù‚:5'},
        {id:'maghrib', n:'ğŸŒ… Ø§Ù„Ù…ØºØ±Ø¨', pts:{m:50,g:30,f:15,q:5}, d:'Ù…:50|Ø¬:30|Ù:15|Ù‚:5'},
        {id:'isha', n:'ğŸŒƒ Ø§Ù„Ø¹Ø´Ø§Ø¡', pts:{m:50,g:30,f:15,q:5}, d:'Ù…:50|Ø¬:30|Ù:15|Ù‚:5'}
      ],
      sunan: [
        {id:'s_fajr', n:'âœ¨ Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±', p:20},
        {id:'s_duha', n:'â˜€ï¸ ØµÙ„Ø§Ø© Ø§Ù„Ø¶Ø­Ù‰', p:25},
        {id:'s_dhuhr_b', n:'âœ¨ Ø§Ù„Ø¸Ù‡Ø± Ù‚Ø¨Ù„', p:20},
        {id:'s_dhuhr_a', n:'âœ¨ Ø§Ù„Ø¸Ù‡Ø± Ø¨Ø¹Ø¯', p:15},
        {id:'s_maghrib', n:'âœ¨ Ø³Ù†Ø© Ø§Ù„Ù…ØºØ±Ø¨', p:15},
        {id:'s_isha', n:'âœ¨ Ø³Ù†Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡', p:15},
        {id:'s_shaf', n:'ğŸ•¯ï¸ Ø§Ù„Ø´ÙØ¹', p:15}
        // Ø§Ù„ÙˆØªØ± Ø£ÙØ¶ÙŠÙ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ø§ÙˆÙŠØ­
      ],
      extra: [
        {id:'azkar_s', n:'â˜€ï¸ Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­', p:30, l:'https://alazkar.today/'},
        {id:'azkar_e', n:'ğŸŒ™ Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡', p:30, l:'https://alazkar.today/'},
        {id:'azkar_n', n:'ğŸ˜´ Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ…', p:30, l:'https://alazkar.today/'},
        {id:'mulk', n:'ğŸ“– Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ù„Ùƒ', p:30, l:'https://quran.com/67'},
        {id:'baqarah_end', n:'ğŸ“– Ø®ÙˆØ§ØªÙŠÙ… Ø§Ù„Ø¨Ù‚Ø±Ø©', p:20, l:'https://quran.com/2/285-286'},
        {id:'quran', n:'ğŸ“– Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ', p:50, l:'https://quran.com'}
      ]
    };

    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);

    // Dark mode
    function toggleDark(){
      document.body.classList.toggle('dark');
      localStorage.setItem('ramadan_dark', document.body.classList.contains('dark'));
    }

    // Helpers
    function fmt12(timeStr){
      if(!timeStr) return "";
      let [h,m] = timeStr.split(':'); h = parseInt(h,10);
      const suf = h>=12 ? "Ù…" : "Øµ";
      h = (h%12)||12;
      return `${h}:${m} ${suf}`;
    }

    async function getHijri(date){
      try{
        const res = await fetch(`https://api.aladhan.com/v1/gToH/${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}`);
        const data = await res.json();
        return data.data.hijri; // {day, month:{ar,en}, year}
      }catch(e){ return null; }
    }

    async function getTimings(city,country){
      const url = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=5`;
      const res = await fetch(url);
      const data = await res.json();
      return data.data.timings; // Fajr,Dhuhr,Asr,Maghrib,Isha
    }

    // State
    let timings = null; // last fetched timings
    let tickHandle = null;

    function loadDay(dateStr){
      const raw = localStorage.getItem('ramadan_day_'+dateStr);
      return raw? JSON.parse(raw) : {};
    }
    function saveDay(dateStr, obj){
      localStorage.setItem('ramadan_day_'+dateStr, JSON.stringify(obj));
    }

    // Rendering
    function renderFard(day){
      const wrap = byId('fardList');
      wrap.innerHTML = model.fard.map(f=>{
        const cur = day[f.id]?.type;
        const opts = Object.entries(f.pts).map(([k,v])=>(
          `<button class="btn ${cur===k?'sel':''}" onclick="save('${f.id}',{type:'${k}',p:${v}})">${k==='m'?'Ù…Ø³Ø¬Ø¯':k==='g'?'Ø¬Ù…Ø§Ø¹Ø©':k==='f'?'ÙØ±Ø¯':'Ù‚Ø¶Ø§Ø¡'}</button>`
        )).join('');
        return `
          <div class="row">
            <div><b>${f.n}</b><span class="pts">${f.d}</span></div>
            <div class="opts">${opts}</div>
          </div>
        `;
      }).join('');
    }

    function renderChecks(list, eid){
      const wrap = byId(eid);
      wrap.innerHTML = list.map(h=>{
        const day = currentDay();
        const done = !!day[h.id]?.done;
        const label = h.l ? `<a href="${h.l}" target="_blank" class="link">${h.n}</a>` : h.n;
        return `
          <div class="row">
            <span>${label} <small class="pts">(+${h.p} Ù†Ù‚Ø·Ø©)</small></span>
            <input type="checkbox" class="check" ${done?'checked':''} onchange="save('${h.id}',{done:this.checked,p:this.checked?${h.p}:0})">
          </div>
        `;
      }).join('');
    }

    function updateTotals(){
      const day = currentDay();
      let total = 0;
      // Points from fard types
      model.fard.forEach(f=>{ if(day[f.id]?.p) total += day[f.id].p; });
      // Taraweeh + Witr
      if(day['taraweeh']?.p) total += day['taraweeh'].p;
      if(day['s_witr']?.p) total += day['s_witr'].p;
      // Sunan
      model.sunan.forEach(s=>{ if(day[s.id]?.p) total += day[s.id].p; });
      // Extra
      model.extra.forEach(e=>{ if(day[e.id]?.p) total += day[e.id].p; });
      // Fasting
      if(day['fasting']?.p) total += day['fasting'].p;

      byId('totalPts').innerText = total;

      // Khatmah progress
      const juz = +((day.khatmah && day.khatmah.juz) || 0);
      const pct = Math.max(0, Math.min(100, Math.round((juz/30)*100)));
      byId('juzBar').style.width = pct+'%';
      byId('juzText').innerText = `ØªÙ‚Ø¯Ù‘Ù… Ø§Ù„Ø®ØªÙ…Ø©: ${pct}% ${juz?`(Ø§Ù„Ø¬Ø²Ø¡ ${juz})`:''}`;
      byId('juzSelect').value = juz || 0;
    }

    function currentDateStr(){ return byId('datePicker').value; }
    function currentDay(){ return loadDay(currentDateStr()); }

    function save(id, val){
      const d = currentDateStr();
      const day = loadDay(d);
      day[id] = val;
      saveDay(d, day);
      updateTotals();
    }

    // Location & timings
    async function applyLocation(){
      const city = (localStorage.getItem('ramadan_city')||'').trim();
      const country = (localStorage.getItem('ramadan_country')||'').trim();
      byId('city').value = city;
      byId('country').value = country;
      const tbody = byId('times');
      if(!city || !country){
        tbody.innerHTML = `<tr class="city-row"><td colspan="5">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø¯ÙˆÙ„Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</td></tr>`;
        return;
      }
      try{
        timings = await getTimings(city,country);
        tbody.innerHTML = `
          <tr class="city-row">
            <td>${fmt12(timings.Fajr)}</td>
            <td>${fmt12(timings.Dhuhr)}</td>
            <td>${fmt12(timings.Asr)}</td>
            <td>${fmt12(timings.Maghrib)}</td>
            <td>${fmt12(timings.Isha)}</td>
          </tr>
        `;
      }catch(e){
        tbody.innerHTML = `<tr class="city-row"><td colspan="5">ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ø¯ÙˆÙ„Ø©.</td></tr>`;
      }
    }

    function saveLocation(){
      localStorage.setItem('ramadan_city', byId('city').value||'');
      localStorage.setItem('ramadan_country', byId('country').value||'');
      applyLocation();
    }

    // Timers
    function asTodayTime(now, hhmm){
      const [h,m] = hhmm.split(':').map(x=>parseInt(x,10));
      const t = new Date(now);
      t.setHours(h,m,0,0);
      return t;
    }

    function diffParts(ms){
      const h = Math.floor(ms/3600000);
      const m = Math.floor((ms%3600000)/60000);
      const s = Math.floor((ms%60000)/1000);
      return `${h}Ø³ ${m}Ø¯ ${s}Ø«`;
    }

    function tick(){
      const now = new Date();
      // Hadith (stable per day)
      const key = currentDateStr();
      const hash = key.split('').reduce((a,b)=>(((a<<5)-a)+b.charCodeAt(0))|0,0);
      byId('hadith').innerText = AHADITH[Math.abs(hash)%AHADITH.length];

      // Hijri
      // (Hijri text updated on date change below via syncHijri)

      // Next prayer banners (if timings present)
      const ban = byId('nextBanner');
      const wAlert = byId('wuduAlert');
      if(timings){
        const map = [
          {key:'Fajr',   n:'Ø§Ù„ÙØ¬Ø±'},
          {key:'Dhuhr',  n:'Ø§Ù„Ø¸Ù‡Ø±'},
          {key:'Asr',    n:'Ø§Ù„Ø¹ØµØ±'},
          {key:'Maghrib',n:'Ø§Ù„Ù…ØºØ±Ø¨'},
          {key:'Isha',   n:'Ø§Ù„Ø¹Ø´Ø§Ø¡'}
        ];
        let next = null, min = Infinity;
        for(const p of map){
          const t = asTodayTime(now, timings[p.key]);
          const diff = t - now;
          if(diff>0 && diff<min){ min = diff; next = {name:p.n, ms:diff}; }
        }
        if(!next){
          // after Isha -> next Fajr of tomorrow
          const t = asTodayTime(now, timings.Fajr); t.setDate(t.getDate()+1);
          const diff = t - now;
          next = {name:'Ø§Ù„ÙØ¬Ø±', ms:diff};
        }
        ban.innerHTML = `â±ï¸ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: <b>${next.name}</b> Ø®Ù„Ø§Ù„ <span class="timer">${diffParts(next.ms)}</span>`;
        const ten = 10*60*1000;
        if(next.ms>0 && next.ms<=ten){
          wAlert.style.display='block';
          wAlert.innerHTML = `ğŸŒŠ Ø¨Ù‚ÙŠ Ø£Ù‚Ù„ Ù…Ù† 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø£Ø°Ø§Ù† <b>${next.name}</b> â€” Ù‡ÙŠØ§ Ù„Ù„ÙˆØ¶ÙˆØ¡ Ù„ØªØ¯Ø±Ùƒ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„.`;
        }else{
          wAlert.style.display='none';
        }

        // Suhoor (till Fajr today or tomorrow) & Iftar (till Maghrib today)
        const fajrT = asTodayTime(now, timings.Fajr);
        const magT  = asTodayTime(now, timings.Maghrib);
        let suhoorMs = fajrT - now; if(suhoorMs<0){ const t = new Date(fajrT); t.setDate(t.getDate()+1); suhoorMs = t - now; }
        let iftarMs  = magT - now;  if(iftarMs<0){ const t = new Date(magT); t.setDate(t.getDate()+1); iftarMs = t - now; }
        byId('suhoorTimer').innerText = diffParts(suhoorMs);
        byId('iftarTimer').innerText  = diffParts(iftarMs);
      }
    }

    async function syncHijri(){
      const d = new Date(currentDateStr());
      const h = await getHijri(d);
      if(h){
        byId('hijri').innerText = `${h.day} ${h.month.ar} ${h.year}Ù‡Ù€`;
        // Ø®Ù„Ø§Ù„ Ø±Ù…Ø¶Ø§Ù†: Ø§Ø¬Ø¹Ù„ Ø§Ù„ØµÙŠØ§Ù… Ù…Ø¹Ù„Ù…Ù‹Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        const inRamadan = (h.month.en === 'Ramadan');
        if(inRamadan){
          // Ù„Ùˆ Ù„Ù… ÙŠÙØ¹ÙŠÙ‘ÙÙ† Ø¨Ø¹Ø¯ØŒ Ø¹ÙŠÙ‘Ù†Ù‡ Ù…Ù† Ø¨Ø§Ø¨ Ø§Ù„ØªÙŠØ³ÙŠØ±
          const day = currentDay();
          if(day.fasting===undefined){
            save('fasting',{done:false,p:0}); // Ù„Ø§ Ù†ÙØ¹Ù‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø§Ø­ØªØ±Ø§Ù…Ù‹Ø§ Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„ØªØªØ¨Ø¹
          }
        }
      }else{
        byId('hijri').innerText = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ';
      }
    }

    function renderAll(){
      // initialize sections
      renderFard(currentDay());
      renderChecks(model.sunan, 'sunanList');
      renderChecks(model.extra, 'extraList');

      // bind fasting/taraweeh/witr states
      const day = currentDay();
      byId('fasting').checked  = !!day.fasting?.done;
      byId('taraweeh').checked = !!day.taraweeh?.done;
      byId('s_witr').checked   = !!day.s_witr?.done;

      updateTotals();
    }

    function onDateChange(){
      renderAll();
      syncHijri();
    }

    // Export / Import
    function exportDay(){
      const d = currentDateStr();
      const data = loadDay(d);
      const blob = new Blob([JSON.stringify({date:d,data},null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ramadan_${d}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importDay(input){
      const file = input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          const d = currentDateStr();
          if(obj && obj.data){
            saveDay(d, obj.data);
            renderAll();
          }else{
            alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.');
          }
        }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.'); }
      };
      reader.readAsText(file);
      input.value='';
    }

    // Init
    window.addEventListener('DOMContentLoaded', async ()=>{
      if(localStorage.getItem('ramadan_dark')==='true') document.body.classList.add('dark');

      // date -> default today
      byId('datePicker').value = new Date().toISOString().split('T')[0];
      byId('datePicker').addEventListener('change', onDateChange);

      // load location inputs & timings
      await applyLocation();

      // initial render
      await syncHijri();
      renderAll();

      // timers
      tick();
      tickHandle = setInterval(tick, 1000);
    });
  </script>
</body>
</html>
